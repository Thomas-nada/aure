<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Aure Node</title>

<!-- Chart.js for Treasury Visualization -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#020617;
  --panel:#020617;
  --border:#1f2937;
  --accent:#facc15;
  --text:#e5e7eb;
  --muted:#9ca3af;
  --success:#22c55e;
  --danger:#ef4444;
  --blue:#60a5fa;
  --treasury:#a855f7;
}

*{ box-sizing:border-box; }

body{
  margin:0;
  padding:24px;
  font-family:system-ui,sans-serif;
  background:radial-gradient(circle at top,#111827,#020617);
  color:var(--text);
}

h1{ margin:0; color:var(--accent); font-size: 1.5rem; }
h2 { color: var(--accent); margin: 0 0 10px 0; font-size: 1.1rem; text-transform: uppercase; letter-spacing: 1px; }

.nav-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  background: rgba(17, 24, 39, 0.5);
  padding: 12px 20px;
  border-radius: 12px;
  border: 1px solid var(--border);
}

.nav-tabs { display: flex; gap: 10px; }

button, select, input, textarea{
  margin:4px;
  padding:8px 12px;
  background:#111827;
  border:1px solid var(--border);
  color:var(--text);
  border-radius:6px;
  font-family: inherit;
  transition: all 0.2s;
}

button:hover{ border-color:var(--accent); cursor:pointer; background: #1a2233; }
button:disabled { opacity: 0.5; cursor: not-allowed; }

.panel{
  border:1px solid var(--border);
  border-radius:10px;
  padding:15px;
  margin-top:12px;
  background:linear-gradient(180deg,#111827,#020617);
}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
  gap:12px;
  margin-top:12px;
}

pre{
  background:#000;
  padding:12px;
  border-radius:8px;
  max-height:400px;
  overflow:auto;
  font-size:12px;
  line-height:1.4;
  white-space:pre-wrap;
  word-break:break-word;
  border: 1px solid #111;
}

.blockRow, .tx-history-row{
  cursor:pointer;
  padding:12px;
  border-radius: 8px;
  margin-bottom: 6px;
  background: rgba(255,255,255,0.03);
  font-size: 13px;
  transition: all 0.2s;
  border: 1px solid transparent;
}

.blockRow:hover, .tx-history-row:hover{ border-color: var(--accent); background:rgba(250, 204, 21, 0.05); }

.tx-history-row { display: grid; grid-template-columns: 1fr auto; align-items: center; }

.kv{
  display:grid;
  grid-template-columns: 140px 1fr;
  gap:6px 10px;
  margin-top:8px;
  font-size:13px;
}

#setupOverlay, #confirmOverlay, #reviewOverlay, #receiptOverlay, #connectionOverlay {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(2, 6, 23, 0.98);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000;
}

.modal {
  background: #111827;
  border: 1px solid var(--border);
  padding: 32px;
  border-radius: 12px;
  max-width: 500px;
  width: 90%;
  text-align: center;
}

.page { display: none; }
.page.active { display: block; }

.address-tag { font-family: monospace; font-size: 11px; background: #000; padding: 6px 10px; border-radius: 4px; color: var(--blue); word-break: break-all; display: inline-block; max-width: 100%; }

.nav-btn-active { background: var(--blue) !important; color: #000 !important; font-weight: bold; border: none; }

.pending-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: rgba(250, 204, 21, 0.1); color: var(--accent); border: 1px solid rgba(250, 204, 21, 0.2); }
.conf-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: rgba(34, 197, 94, 0.1); color: var(--success); border: 1px solid rgba(34, 197, 94, 0.2); }

.stat-val { font-size: 1.4rem; font-weight: bold; display: block; }
.stat-label { font-size: 0.7rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }

.filter-bar { display: flex; gap: 5px; flex-wrap: wrap; }
.filter-btn { font-size: 11px; padding: 4px 10px; }
.filter-btn.active { background: var(--accent); color: #000; border-color: var(--accent); }

#notificationBox {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    pointer-events: none;
}
.toast {
    background: #1e293b;
    border: 1px solid var(--border);
    color: var(--text);
    padding: 12px 20px;
    border-radius: 8px;
    margin-bottom: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    font-size: 13px;
    opacity: 0;
    transform: translateY(-20px);
    transition: all 0.3s ease;
}
.toast.show { opacity: 1; transform: translateY(0); }
</style>
</head>

<body>

<div id="notificationBox"></div>

<!-- CONNECTION OVERLAY -->
<div id="connectionOverlay" style="display: none;">
    <div class="modal">
        <h2>Network Configuration</h2>
        <p class="muted" style="font-size: 12px;">The node at <b>16.171.60.136</b> is currently unreachable.</p>
        <input id="nodeIpInput" placeholder="Enter Node IP (e.g. 16.171.60.136)" style="text-align: center; width: 100%; margin: 15px 0;" />
        <button onclick="saveNodeIp()" style="background: var(--blue); color: #000; font-weight: bold; width: 100%;">Reconnect</button>
        <button onclick="tryLocalhost()" style="width: 100%; margin-top: 8px; font-size: 11px;">Switch to Localhost</button>
    </div>
</div>

<!-- SETUP OVERLAY -->
<div id="setupOverlay" style="display: none;">
  <div class="modal">
    <h2>Wallet Setup</h2>
    <p class="muted" style="font-size: 12px; margin-bottom: 10px;">Copy and save this recovery seed in a safe place.</p>
    <pre id="setupSeed" style="color: var(--accent); margin: 10px 0; border: 1px dashed var(--accent); padding: 15px; font-weight: bold;"></pre>
    <button onclick="copyToClipboard(document.getElementById('setupSeed').textContent)" style="font-size: 11px; padding: 4px 10px; margin-bottom: 15px;">Copy Recovery Seed</button>
    <div style="position:relative; margin-top: 10px;">
        <input id="setupPin" type="password" maxlength="6" placeholder="Set a 4-6 digit PIN" style="text-align: center; width: 100%;" />
        <span onclick="toggleSetupPin()" style="position:absolute; right: 15px; top:12px; cursor:pointer; font-size:12px;">üëÅ</span>
    </div>
    <button onclick="saveSetupPin()" style="background: var(--success); color: #000; font-weight: bold; width: 100%; margin-top: 15px; height: 45px;">Secure Identity & Continue</button>
  </div>
</div>

<div id="reviewOverlay" style="display: none;">
  <div class="modal">
    <h2>Review Transaction</h2>
    <div class="panel" style="text-align: left; margin: 20px 0;">
      <div class="kv">
        <div>Recipient</div><div id="reviewRecipient" class="address-tag"></div>
        <div>Amount</div><div id="reviewAmount" style="font-weight: bold;"></div>
        <div>Network Fee</div><div style="color: var(--danger); font-weight: bold;">+ 1.00 AUR</div>
        <div>Total Cost</div><div id="reviewTotal" style="font-size: 1.1rem; border-top: 1px solid #333; padding-top: 5px;"></div>
      </div>
    </div>
    <button onclick="confirmToPin()" style="background: var(--blue); color: #000; font-weight: bold; width: 100%;">Proceed to Sign</button>
    <button onclick="cancelTx()" style="width: 100%; margin-top: 8px;">Cancel</button>
  </div>
</div>

<div id="confirmOverlay" style="display: none;">
  <div class="modal">
    <h2>Authorize PIN</h2>
    <input id="confirmPin" type="password" maxlength="6" style="text-align: center; font-size: 24px; width: 160px;" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
    <div style="margin-top: 15px;">
      <button onclick="authorizeSign()" style="background: var(--blue); color: #000; font-weight: bold; width: 100%;">Authorize & Submit</button>
      <button onclick="cancelTx()" style="width: 100%; margin-top: 8px;">Cancel</button>
    </div>
  </div>
</div>

<div id="receiptOverlay" style="display: none;">
    <div class="modal">
        <h2>Transaction Receipt</h2>
        <div id="receiptContent" style="text-align: left; margin: 15px 0;"></div>
        <button onclick="closeReceipt()" style="width: 100%;">Close</button>
    </div>
</div>

<!-- NAV -->
<div class="nav-header">
  <div style="display: flex; align-items: center; gap: 15px;">
    <h1>‚õè Aure</h1>
    <div id="status" class="muted" style="font-size: 12px;">Connecting to Network...</div>
  </div>
  <div class="nav-tabs">
    <button onclick="showPage('dashboardPage')" id="tab-dashboardPage" class="nav-btn-active">Dashboard</button>
    <button onclick="showPage('miningPage')" id="tab-miningPage">Mining</button>
    <button onclick="showPage('walletPage')" id="tab-walletPage">My Wallet</button>
  </div>
</div>

<!-- PAGES -->
<div id="dashboardPage" class="page active">
  <div class="grid" style="grid-template-columns: repeat(5, 1fr);">
    <div class="panel"> <span class="stat-label">HEIGHT</span> <span id="height" class="stat-val">-</span> </div>
    <div class="panel"> <span class="stat-label">TOTAL SUPPLY</span> <span id="totalSupply" class="stat-val">0.00</span> </div>
    <div class="panel"> 
        <span class="stat-label">TREASURY</span> 
        <span id="treasuryBalance" class="stat-val" style="color: var(--treasury); cursor:pointer;" onclick="copyTreasuryToWallet()" title="Click to send funds to treasury">0.00</span> 
    </div>
    <div class="panel"> <span class="stat-label">DIFFICULTY</span> <span id="dashDiff" class="stat-val">0.00</span> </div>
    <div class="panel"> <span class="stat-label">PEERS</span> <span id="peerCount" class="stat-val">0</span> </div>
  </div>

  <div class="grid" style="grid-template-columns: 1.5fr 1fr;">
    <div class="panel">
        <div style="display:flex; justify-content:space-between;">
            <h2>Treasury Growth</h2>
            <button onclick="copyTreasuryToWallet()" style="font-size:10px; padding:2px 8px; margin:0;">Deposit to Treasury</button>
        </div>
        <div style="height: 180px;"><canvas id="treasuryChart"></canvas></div>
    </div>
    <div class="panel">
        <h2>Rich List</h2>
        <pre id="richList" style="max-height: 180px;">-</pre>
    </div>
  </div>

  <div class="grid">
    <div class="panel"><h2>Ledger Explorer</h2><div id="ledgerExplorer" style="max-height: 250px; overflow: auto;"></div></div>
    <div class="panel"><h2>Block Details</h2><pre id="blockDetails">Select a block.</pre></div>
  </div>
</div>

<div id="miningPage" class="page">
  <div class="grid">
      <div class="panel">
          <h2>Mining Controls</h2>
          <button onclick="startContinuous()" style="background:var(--success); color:#000; font-weight:bold; width: 100%; height: 45px; margin-bottom: 10px;">Start Continuous Mining</button>
          <button onclick="stopMining()" style="width: 100%;">Stop Mining</button>
          <div class="kv" style="margin-top: 15px;">
              <div>Status</div><div id="mode" style="font-weight:bold;">OFF</div>
              <div>Hashrate</div><div id="hashrate">0 H/s</div>
              <div>Difficulty</div><div id="miningDiff">0.000</div>
          </div>
      </div>
      <div class="panel">
          <h2>Mining Insights</h2>
          <div class="kv">
              <div>ETA Next Block</div><div id="mineETA" style="color: var(--blue); font-weight: bold;">-</div>
              <div>Total Earned</div><div id="mineTotalRewards" style="color: var(--accent); font-weight: bold;">0.00 AUR</div>
              <div>Estimated Fees</div><div id="mineEstFees" style="color: var(--success);">0.00 AUR</div>
          </div>
      </div>
  </div>
  <div class="panel"><h2>Mining Reward Log</h2><div id="miningHistory"></div></div>
</div>

<div id="walletPage" class="page">
  <div class="grid">
    <div class="panel">
      <h2>Account</h2>
      <div class="kv">
          <div>Balance</div><div id="balance" style="font-size:1.5rem; color:var(--accent); font-weight:bold;">0.00</div>
          <div>Address</div><div id="nodeId" class="address-tag" style="cursor:pointer;" onclick="copyToClipboard(this.textContent)">-</div>
      </div>
    </div>
    <div class="panel">
      <h2>Submit Transaction</h2>
      <div style="margin-bottom: 8px;"><small class="muted">Fee: 1.00 AUR applied to all transfers.</small></div>
      <input id="txRecipient" placeholder="Recipient Address" />
      <input id="txAmount" type="number" step="0.01" placeholder="Amount (AUR)" />
      <input id="txMessage" placeholder="Message (Optional)" />
      <button onclick="initiateTx()" style="background:var(--blue); color:#000; font-weight:bold; width:100%; margin-top:10px; height: 40px;">Review & Submit Tx</button>
    </div>
  </div>
  <div class="panel">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <h2>Transfer History</h2>
          <div class="filter-bar">
              <button class="filter-btn active" id="filter-all" onclick="setHistoryFilter('all')">All</button>
              <button class="filter-btn" id="filter-sent" onclick="setHistoryFilter('sent')">Sent</button>
              <button class="filter-btn" id="filter-received" onclick="setHistoryFilter('received')">Received</button>
              <button class="filter-btn" id="filter-mining" onclick="setHistoryFilter('mining')">Mining</button>
          </div>
      </div>
      <div id="txHistory"></div>
  </div>
</div>

<script>
/* ======================
   CORE STATE & CONSTANTS
====================== */
let SERVER_URL = "ws://16.171.60.136:8080";
const TREASURY_ADDRESS = "AUR000000000000000000000000000000005FEC";
const TX_FEE = 1.0;

let ws = null, worker = null, currentTemplate = null;
let wallet = { address: null, hasPin: false };
let miningIntent = "off", hashes = 0, lastTick = Date.now();
let chain = [], balances = {}, mempool = [], treasuryChart = null;
let historyFilter = 'all', pendingTx = null;

const updateEl = (id, text, isHTML = false) => { 
    const el = document.getElementById(id); 
    if (el) {
        if (isHTML) el.innerHTML = text;
        else el.textContent = text;
    }
};

function notify(msg, err=false) {
    const b = document.getElementById("notificationBox");
    const t = document.createElement("div");
    t.className = `toast ${err?'toast-error':'toast-success'}`; t.textContent = msg;
    b.appendChild(t); setTimeout(()=>t.classList.add("show"),10);
    setTimeout(()=>{ t.classList.remove("show"); setTimeout(()=>t.remove(),300); }, 3000);
}

const sha256_standard = function(ascii) {
    function rightRotate(value, amount) { return (value >>> amount) | (value << (32 - amount)); }
    let mathPow = Math.pow, maxWord = mathPow(2, 32), result = '';
    let words = [], asciiBitLength = ascii.length * 8;
    let hash = [0x6a09e667, 0xbb67ae85, 0x3c6ef372, 0xa54ff53a, 0x510e527f, 0x9b05688c, 0x1f83d9ab, 0x5be0cd19];
    let k = [0x428a2f98, 0x71374491, 0xb5c0fbcf, 0xe9b5dba5, 0x3956c25b, 0x59f111f1, 0x923f82a4, 0xab1c5ed5, 0xd807aa98, 0x12835b01, 0x243185be, 0x550c7dc3, 0x72be5d74, 0x80deb1fe, 0x9bdc06a7, 0xc19bf174, 0xe49b69c1, 0xefbe4786, 0x0fc19dc6, 0x240ca1cc, 0x2de92c6f, 0x4a7484aa, 0x5cb0a9dc, 0x76f988da, 0x983e5152, 0xa831c66d, 0xb00327c8, 0xbf597fc7, 0xc6e00bf3, 0xd5a79147, 0x06ca6351, 0x14292967, 0x27b70a85, 0x2e1b2138, 0x4d2c6dfc, 0x53380d13, 0x650a7354, 0x766a0abb, 0x81c2c92e, 0x92722c85, 0xa2bfe8a1, 0xa81a664b, 0xc24b8b70, 0xc76c51a3, 0xd192e819, 0xd6990624, 0xf40e3585, 0x106aa070, 0x19a4c116, 0x1e376c08, 0x2748774c, 0x34b0bcb5, 0x391c0cb3, 0x4ed8aa4a, 0x5b9cca4f, 0x682e6ff3, 0x748f82ee, 0x78a5636f, 0x84c87814, 0x8cc70208, 0x90befffa, 0xa4506ceb, 0xbef9a3f7, 0xc67178f2];
    ascii += '\x80'; while (ascii.length % 64 - 56) ascii += '\x00';
    for (let i = 0; i < ascii.length; i++) { let j = ascii.charCodeAt(i); words[i >> 2] |= j << ((3 - i) % 4) * 8; }
    words[words.length] = ((asciiBitLength / maxWord) | 0); words[words.length] = (asciiBitLength | 0);
    for (let j = 0; j < words.length; ) {
        let w = words.slice(j, j += 16), oldHash = hash.slice(0);
        for (let i = 0; i < 64; i++) {
            let i2 = i + j, w15 = w[i - 15], w2 = w[i - 2], s0 = rightRotate(w15, 7) ^ rightRotate(w15, 18) ^ (w15 >>> 3), s1 = rightRotate(w2, 17) ^ rightRotate(w2, 19) ^ (w2 >>> 10), ch = (hash[4] & hash[5]) ^ (~hash[4] & hash[6]), maj = (hash[0] & hash[1]) ^ (hash[0] & hash[2]) ^ (hash[1] & hash[2]);
            let t1 = hash[7] + (rightRotate(hash[4], 6) ^ rightRotate(hash[4], 11) ^ rightRotate(hash[4], 25)) + ch + k[i] + (w[i] = (i < 16) ? w[i] : (w[i - 16] + s0 + w[i - 7] + s1) | 0), t2 = (rightRotate(hash[0], 2) ^ rightRotate(hash[0], 13) ^ rightRotate(hash[0], 22)) + maj;
            hash = [(t1 + t2) | 0].concat(hash); hash[4] = (hash[4] + t1) | 0; hash.length = 8;
        }
        for (let i = 0; i < 8; i++) hash[i] = (hash[i] + oldHash[i]) | 0;
    }
    for (let i = 0; i < 8; i++) { for (let j = 3; j + 1; j--) { let b = (hash[i] >> (j * 8)) & 255; result += (b < 16 ? '0' : '') + b.toString(16); } }
    return result;
};

function isAddressValid(address) {
    if (!address) return false;
    if (address === TREASURY_ADDRESS) return true;
    if (!address.startsWith("AUR") || address.length !== 39) return false;
    const raw = address.slice(3, 35);
    const check = address.slice(35);
    const expectedCheck = sha256_standard(raw).slice(0, 4).toUpperCase();
    return check === expectedCheck;
}

/* ======================
   CONNECTION LOGIC
====================== */
function saveNodeIp() {
    const ip = document.getElementById("nodeIpInput").value.trim();
    if (!ip) return notify("Please enter a valid IP", true);
    SERVER_URL = `ws://${ip}:8080`;
    document.getElementById("connectionOverlay").style.display = "none";
    connect();
}

function tryLocalhost() {
    SERVER_URL = "ws://localhost:8080";
    document.getElementById("connectionOverlay").style.display = "none";
    connect();
}

function connect() {
  if (ws) { ws.close(); ws = null; }
  updateEl("status", "Connecting...");
  
  ws = new WebSocket(SERVER_URL);
  
  ws.onopen = () => {
      updateEl("status", "Live: " + SERVER_URL.replace("ws://", ""));
      notify("Connected to Aure Mainnet.");
  };

  ws.onerror = () => {
      updateEl("status", "Network Error");
      document.getElementById("connectionOverlay").style.display = "flex";
  };

  ws.onmessage = (e) => {
    const msg = JSON.parse(e.data);
    if (msg.type === "identity_info") {
      wallet.address = msg.address; wallet.hasPin = msg.hasPin; 
      updateEl("nodeId", msg.address);
      if (!msg.hasPin) {
          updateEl("setupSeed", msg.seed); 
          document.getElementById("setupOverlay").style.display = "flex";
      }
      ws.send(JSON.stringify({ type: "announce", nodeId: wallet.address }));
    }
    if (msg.type === "connected" || msg.type === "chain_update" || msg.type === "mempool_update") {
      if (msg.balances) balances = msg.balances; if (msg.chain) chain = msg.chain; if (msg.mempool) mempool = msg.mempool;
      renderExplorer(); renderHistory(); updateTreasuryChart(); updateUI();
    }
    if (msg.type === "start_block") {
      currentTemplate = msg.data; 
      updateEl("height", msg.data.height); 
      updateEl("dashDiff", msg.data.difficulty.toFixed(2)); 
      updateEl("miningDiff", msg.data.difficulty.toFixed(3)); 
      if (miningIntent !== "off") startWorker();
    }
    if (msg.type === "tx_success") { document.getElementById("confirmOverlay").style.display = "none"; notify("Tx Confirmed."); }
    if (msg.type === "tx_error") notify(msg.message, true);
  };
}

/* ======================
   MINING & UI
====================== */
function startWorker() {
  if (!currentTemplate || !wallet.address) return;
  worker?.terminate(); hashes = 0;
  const userTxs = currentTemplate.transactions || [];
  const totalFees = userTxs.length * TX_FEE;
  const cbMiner = { from: "system", to: wallet.address, amount: (50 * 0.99) + (totalFees * 0.5), type: "coinbase", timestamp: Date.now(), nonce: 0, id: "cbm-"+Date.now() };
  const cbTreasury = { from: "system", to: TREASURY_ADDRESS, amount: (50 * 0.01) + (totalFees * 0.5), type: "treasury", timestamp: Date.now(), nonce: 0, id: "cbt-"+Date.now() };
  const block = { ...currentTemplate, miner: wallet.address, transactions: [cbMiner, cbTreasury, ...userTxs] };
  
  const blob = `const sha256 = ${sha256_standard.toString()}; 
    self.onmessage = (e) => { 
      const b = e.data; let n = 0; const txs = JSON.stringify(b.transactions); 
      const target = BigInt('0x' + b.target);
      while(true){ 
        const h = sha256(b.height + b.prevHash + b.timestamp + n + b.miner + txs); 
        if (n > 0 && n % 100 === 0) self.postMessage("hash-100"); 
        if(BigInt('0x' + h) < target){ 
          self.postMessage({type:"found",block:{...b,nonce:n,hash:h}}); 
          break; 
        } 
        n++; 
      } 
    };`;
    
  worker = new Worker(URL.createObjectURL(new Blob([blob], {type: "application/javascript"})));
  worker.onmessage = (e) => { 
      if(e.data === "hash-100") hashes += 100;
      else if(e.data.type === "found" && ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({type:"submit_block", data:e.data.block, miner:wallet.address}));
      }
  };
  worker.postMessage(block);
}

function updateTreasuryChart() {
    const canvas = document.getElementById('treasuryChart');
    if (!canvas || !chain || !chain.length) return;
    let running = 0; const data = [], labels = [];
    chain.forEach(b => { 
        (b.transactions||[]).forEach(tx => { if(tx.to===TREASURY_ADDRESS) running += tx.amount; }); 
        data.push(running); labels.push(`#${b.height}`); 
    });
    if (treasuryChart) treasuryChart.destroy();
    treasuryChart = new Chart(canvas.getContext('2d'), {
        type: 'line', 
        data: { labels, datasets: [{ label: 'Treasury Balance', data, borderColor: '#a855f7', backgroundColor: 'rgba(168, 85, 247, 0.1)', borderWidth: 2, pointRadius: 0, fill: true, tension: 0.3 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#9ca3af', font: { size: 10 } } } } }
    });
}

function updateUI() {
    updateEl("balance", (balances[wallet.address] || 0).toFixed(2));
    updateEl("treasuryBalance", (balances[TREASURY_ADDRESS] || 0).toFixed(2));
    updateEl("totalSupply", Object.values(balances).reduce((a,b)=>a+b,0).toFixed(2));
    updateEl("peerCount", Object.keys(balances).length);
    const sorted = Object.entries(balances).sort((a,b)=>b[1]-a[1]).slice(0,10);
    updateEl("richList", sorted.map(([id,amt])=>`${id.slice(0,12)}...: ${amt.toFixed(2)}`).join("\n"));
    const myRewards = chain.flatMap(b=>b.transactions||[]).filter(tx=>tx.to===wallet.address && tx.from==="system");
    updateEl("mineTotalRewards", myRewards.reduce((a,b)=>a+b.amount,0).toFixed(2) + " AUR");
}

function renderHistory() {
    const curHeight = chain.length > 0 ? chain.at(-1).height : 0;
    const all = [...mempool, ...chain.flatMap(b => (b.transactions || []).map(tx => ({ ...tx, blockHeight: b.height })))].filter(tx => tx.from === wallet.address || tx.to === wallet.address).sort((a,b) => b.timestamp - a.timestamp);
    const filtered = all.filter(tx => {
        const isMin = tx.from === 'system';
        if (historyFilter === 'sent') return tx.from === wallet.address && !isMin;
        if (historyFilter === 'received') return tx.to === wallet.address && !isMin;
        if (historyFilter === 'mining') return isMin;
        return true;
    });
    updateEl("txHistory", filtered.map(tx => renderTxRow(tx, curHeight)).join("") || "No activity.", true);
}

function renderTxRow(tx, curHeight) {
    const isMin = tx.from === "system";
    const confs = tx.blockHeight !== undefined ? (curHeight - tx.blockHeight + 1) : 0;
    const badge = confs === 0 ? `<span class="pending-badge">Pending</span>` : `<span class="conf-badge">${confs} Confs</span>`;
    return `<div class="tx-history-row" onclick='viewReceipt(${JSON.stringify(tx)})'><div><b>${tx.from===wallet.address?'SENT':isMin?'REWARD':'RECEIVED'}</b><br/><small class="muted">${tx.id.slice(0,8)}</small></div><div style="text-align:right;">${badge}<br/><b>${tx.from===wallet.address?'-':'+'}${tx.amount.toFixed(2)}</b></div></div>`;
}

function initiateTx() {
    const to = document.getElementById("txRecipient").value.trim(), amt = parseFloat(document.getElementById("txAmount").value);
    if (!isAddressValid(to)) return notify("Invalid address", true);
    if (isNaN(amt) || amt <= 0) return notify("Invalid amount", true);
    pendingTx = { from: wallet.address, to, amount: amt, timestamp: Date.now() };
    updateEl("reviewRecipient", to); updateEl("reviewAmount", amt.toFixed(2) + " AUR"); updateEl("reviewTotal", (amt+TX_FEE).toFixed(2) + " AUR");
    document.getElementById("reviewOverlay").style.display = "flex";
}

function saveSetupPin() { 
    const pin = document.getElementById("setupPin").value.trim();
    if (pin.length < 4) return notify("PIN too short", true);
    ws.send(JSON.stringify({ type: "set_pin", pin })); 
    document.getElementById("setupOverlay").style.display = "none"; 
}

function authorizeSign() { ws.send(JSON.stringify({ type: "request_signature", pin: document.getElementById("confirmPin").value, tx: pendingTx })); }
function showPage(p) { 
    document.querySelectorAll(".page").forEach(el => el.classList.remove("active"));
    document.querySelectorAll(".nav-tabs button").forEach(b => b.classList.remove("nav-btn-active"));
    document.getElementById(p).classList.add("active");
    document.getElementById("tab-"+p).classList.add("nav-btn-active");
    if (p === 'dashboardPage') setTimeout(updateTreasuryChart, 50);
}

function renderExplorer() {
    let html = ""; 
    chain.slice(-20).reverse().forEach(b => html += `<div class="blockRow" onclick="selectBlock(${chain.indexOf(b)})">#${b.height} - ${b.hash.slice(0,16)}...</div>`);
    updateEl("ledgerExplorer", html, true);
}

function copyToClipboard(t) { const e = document.createElement('textarea'); e.value = t; document.body.appendChild(e); e.select(); document.execCommand('copy'); document.body.removeChild(e); notify("Copied!"); }
function copyTreasuryToWallet() { document.getElementById("txRecipient").value = TREASURY_ADDRESS; showPage('walletPage'); }
function toggleSetupPin() { const el = document.getElementById("setupPin"); el.type = el.type === "password" ? "text" : "password"; }
function confirmToPin() { document.getElementById("reviewOverlay").style.display = "none"; document.getElementById("confirmOverlay").style.display = "flex"; }
function cancelTx() { document.getElementById("reviewOverlay").style.display="none"; document.getElementById("confirmOverlay").style.display="none"; }
function closeReceipt() { document.getElementById("receiptOverlay").style.display = "none"; }
function selectBlock(i) { updateEl("blockDetails", JSON.stringify(chain[i], null, 2)); }
function stopMining() { miningIntent = "off"; worker?.terminate(); updateEl("mode", "OFF"); }
function startContinuous() { miningIntent = "continuous"; updateEl("mode", "Mining..."); startWorker(); }
function setHistoryFilter(f) { historyFilter = f; renderHistory(); }

function viewReceipt(tx) {
    document.getElementById("receiptContent").innerHTML = `<div class="kv"><div>Tx ID</div><div class="address-tag">${tx.id}</div><div>From</div><div>${tx.from}</div><div>To</div><div>${tx.to}</div><div>Net Amount</div><div style="color:var(--accent)">${tx.amount.toFixed(2)} AUR</div><div>Block</div><div>${tx.blockHeight ?? 'Pending'}</div></div>`;
    document.getElementById("receiptOverlay").style.display = "flex";
}

setInterval(() => { 
    if(Date.now()-lastTick > 1000){ 
        updateEl("hashrate", hashes + " H/s"); hashes = 0; lastTick = Date.now(); updateUI();
    } 
}, 1000);

window.onload = connect;
</script>
</body>
</html>
